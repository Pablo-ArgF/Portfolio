---
import { getCollection, render } from 'astro:content';

const experiences = (await getCollection('experience')).sort(
  (a, b) => new Date(b.data.startDate).getTime() - new Date(a.data.startDate).getTime()
);

const contents = await Promise.all(
  experiences.map(async (experience) => {
    const { Content } = await render(experience);
    return { id: experience.id, Content };
  })
);
---

<section class="tw-relative tw-flex tw-flex-col tw-items-center tw-py-20 tw-overflow-hidden">
  <h2 class="tw-text-4xl tw-font-medium tw-text-gray-200 max-md:tw-text-3xl tw-mb-16">
    Experience
  </h2>

  <!-- Timeline -->
  <ol class="tw-relative tw-w-full tw-max-w-[900px] tw-flex tw-flex-col tw-mx-auto">
    <!-- Línea vertical -->
    <div class="tw-absolute tw-left-[84px] tw-top-0 tw-bottom-0 tw-w-[3px] tw-bg-gray-100"></div>

    {experiences.map(({ id, data }) => {
      const item = contents.find((content) => content.id === id);
      const Content = item?.Content;
      return (
        <li
          id={id}
          class="tw-relative tw-flex tw-items-start tw-gap-12 tw-ml-[180px] tw-mb-24 tw-opacity-0 tw-translate-y-10 tw-transition-all tw-duration-700 tw-ease-out reveal"
        >
          <!-- Esfera del logo -->
          <span
            class="tw-absolute tw-left-[-140px] tw-flex tw-items-center tw-justify-center tw-w-24 tw-h-24 
                   tw-bg-gradient-to-b tw-from-gray-900 tw-to-gray-700 tw-rounded-full 
                   tw-border tw-border-gray-500 tw-ring-8 tw-ring-gray-900/30 tw-shadow-xl"
          >
            <img
              src={data.logo}
              alt={data.company}
              class="tw-w-16 tw-h-16.5 tw-object-contain tw-filter tw-grayscale 
                     tw-transition-all tw-duration-500 hover:tw-grayscale-0"
            />
          </span>

          <!-- Contenido -->
          <div class="tw-flex tw-flex-col tw-gap-3 tw-text-gray-200 tw-max-w-[640px]">
            <time class="tw-text-sm tw-text-gray-400">
              {new Date(data.startDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short'
              })}{' '}
              –{' '}
              {data.endDate
                ? new Date(data.endDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short'
                  })
                : 'Now'}
            </time>

            <h3 class="tw-text-3xl tw-font-semibold">{data.position}</h3>
            <p class="tw-text-gray-400">{data.company} — {data.location}</p>

            {Content && (
              <div class="tw-mt-3 tw-text-gray-300 tw-leading-relaxed">
                <Content />
              </div>
            )}
          </div>
        </li>
      );
    })}
  </ol>
</section>

<!-- Script para animar al hacer scroll -->
<script>
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.remove('tw-opacity-0', 'tw-translate-y-10');
          entry.target.classList.add('tw-opacity-100', 'tw-translate-y-0');
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.9 }
  );

  document.querySelectorAll('.reveal').forEach((el) => observer.observe(el));
</script>
