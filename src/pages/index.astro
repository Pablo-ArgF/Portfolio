---
import Layout from "../layouts/Layout.astro";
import SplashCursor from "../components/SplashCursor.tsx";
import ExperienceTimeline from "../components/ExperienceTimeline.astro";

import { getCollection } from "astro:content";
import { ReviewsFlow } from "../components/ReviewsFlow";
import ProjectsShowcase from "../components/ProjectsShowcase.tsx";
import { promise } from "astro:schema";
import ContactSection from "../components/ContactSection";
import TechStack from "../components/TechStack";

const reviews = await getCollection("review");
const projects = (await getCollection("project")).sort((a, b) =>
  b.data.fechaInicio.localeCompare(a.data.fechaInicio),
);

const experiences = await getCollection("experience");

const parseDate = (dateStr: string) => {
  const [year, month] = dateStr.split("-").map(Number);
  return new Date(year, month - 1);
};

let yearsOfExperience = 0;
let currentCompany = "Tech Company";

if (experiences.length > 0) {
  const startDates = experiences.map((exp) =>
    parseDate(exp.data.startDate).getTime(),
  );
  const minStartDate = new Date(Math.min(...startDates));
  const now = new Date();
  const diffYears =
    (now.getTime() - minStartDate.getTime()) / (1000 * 60 * 60 * 24 * 365.25);
  yearsOfExperience = Math.ceil(diffYears * 2) / 2;

  const sortedExperiences = experiences.sort((a, b) =>
    b.data.startDate.localeCompare(a.data.startDate),
  );
  const activeRole =
    sortedExperiences.find((exp) => !exp.data.endDate) || sortedExperiences[0];
  currentCompany = activeRole.data.company;
}
---

<Layout>
  <header
    class="tw-max-w-lg:tw-px-4 tw-max-w-lg:tw-mr-auto tw-absolute tw-top-0 tw-z-20 tw-flex tw-h-[60px] tw-w-full tw-bg-opacity-0 tw-px-[5%] lg:tw-justify-around"
  >
    <div
      class="collapsible-header animated-collapse max-lg:tw-shadow-md"
      id="collapsed-header-items"
    >
      <div
        class="tw-flex tw-h-full tw-w-max tw-gap-5 tw-text-base
          max-lg:tw-mt-[30px] max-lg:tw-flex-col max-lg:tw-place-items-end max-lg:tw-gap-5
          lg:tw-mx-auto lg:tw-place-items-center
          tw-bg-black tw-px-4 tw-py-2 tw-rounded-xl tw-z-50"
      >
        <a class="header-links" href="#techStack">Tech Stack</a>
        <a class="header-links" href="#experience">Experience</a>
        <a class="header-links" href="#projects">Projects</a>
        <a class="header-links" href="#reviews">Reviews</a>
        <a class="header-links" href="#contact">Contact</a>
      </div>
    </div>
    <button
      class="bi bi-list tw-absolute tw-right-3 tw-top-3 tw-z-50 tw-text-3xl tw-text-white lg:tw-hidden"
      onclick="toggleHeader()"
      aria-label="menu"
      id="collapse-btn"></button>
  </header>

  <section
    class="hero-section tw-relative tw-flex tw-min-h-[100vh] tw-w-full tw-max-w-[100vw] tw-flex-col tw-overflow-hidden max-md:tw-mt-[50px]"
    id="hero-section"
  >
    <div>
      <SplashCursor client:load />
      <div
        class="tw-flex tw-h-full tw-min-h-[100vh] tw-w-full tw-flex-col tw-place-content-center tw-gap-6 tw-p-[5%] max-xl:tw-place-items-center max-lg:tw-p-4"
      >
        <div
          class="tw-flex tw-flex-col tw-place-content-center tw-items-center"
        >
          <div
            class="reveal-up gradient-text tw-text-center tw-text-6xl tw-font-semibold tw-uppercase tw-leading-[80px] max-lg:tw-text-4xl max-md:tw-leading-snug"
          >
            <span class=""> Pablo Argallero </span>
            <br />
            <span class=""> Fernández </span>
          </div>
          <div
            class="reveal-up tw-mt-10 tw-max-w-[500px] tw-p-2 tw-text-center tw-text-gray-300 max-lg:tw-max-w-full"
          >
            Software Engineer with {yearsOfExperience} years of experience, passionate
            about continuous learning and constant improvement. Graduated from the
            University of Oviedo with 13 “with honors” distinctions. Currently working
            at {currentCompany}.
          </div>

          <div
            class="reveal-up tw-mt-10 tw-flex tw-place-items-center tw-gap-4"
          >
            <a
              href="/Pablo_Argallero_resume.pdf"
              download="Pablo_Argallero_resume.pdf"
              data-track-event="Click CV Download"
              class="tw-inline-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-white hover:tw-bg-gray-200
                      tw-text-black tw-font-medium tw-rounded-full tw-px-5 tw-py-2 tw-transition-colors"
            >
              <span>Download CV</span>
            </a>
            <a
              class="tw-inline-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-black tw-text-white  tw-font-medium tw-rounded-full tw-px-5 tw-py-2 tw-transition-colors tw-duration-[0.3s] hover:tw-bg-white hover:tw-text-black"
              href="#contact"
            >
              <i class="bi bi-envelope-fill"></i>
              <span>Contact Me</span>
            </a>
          </div>
        </div>

        <div
          class="reveal-up tw-relative tw-mt-8 tw-flex tw-w-full tw-place-content-center tw-place-items-center"
          id="myimage-container"
        >
          <div
            class="tw-relative tw-flex tw-place-content-center tw-place-items-center"
            id="myimage-wrapper"
          >
            <img
              src="me.png"
              alt="Mi foto"
              class="tw-rounded-full tw-w-60 tw-h-60 tw-object-cover tw-shadow-lg"
            />
          </div>
        </div>
      </div>
    </div>
  </section>

  <section
    id="techStack"
    class="tw-relative tw-flex tw-w-full tw-max-w-[100vw] tw-flex-col tw-place-content-center tw-place-items-center tw-overflow-hidden tw-p-8"
  >
    <h2 class="tw-text-4xl tw-font-medium tw-text-gray-200 max-md:tw-text-3xl">
      Tech Stack
    </h2>

    <TechStack client:load />
  </section>
  <div id="experience">
    <ExperienceTimeline />
  </div>
  <div id="projects">
    <ProjectsShowcase projects={projects} client:only />
  </div>
  <div id="reviews">
    <ReviewsFlow reviews={reviews} client:only />
  </div>

  <div id="contact">
    <ContactSection
      githubUrl="https://github.com/Pablo-ArgF"
      linkedinUrl="https://www.linkedin.com/in/pablo-argallero/"
      client:only
    />
  </div>

  <script>
    const handleScroll = () => {
      const hash = window.location.hash;
      if (hash) {
        const target = document.querySelector(hash);
        if (target) {
          target.scrollIntoView({ behavior: "smooth" });
        }
      }
    };

    // Attempt to scroll multiple times to catch delayed hydration
    document.addEventListener("astro:page-load", () => {
      setTimeout(handleScroll, 100);
      setTimeout(handleScroll, 500);
      setTimeout(handleScroll, 1000);
    });
  </script>
</Layout>
